name: PIO Lib

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"

jobs:
  PlatformIO-Check:
    name: PlatformIO - Run checks
    uses: sensirion/.github/.github/workflows/upt.platformio.check.yml@main
    with:
      pio-environment-list: '["BleAdvertisementSamples", "BleGadgetWithSettings", "BleGadgetWithSettings", "BleGadgetWithFrc"]'

  PlatformIO-Build:
    name: PlatformIO - Build
    uses: sensirion/.github/.github/workflows/upt.platformio.build.yml@main
    needs: PlatformIO-Check
    with:
      pio-environment-list: '["BleAdvertisementSamples", "BleGadgetWithSettings", "BleGadgetWithSettings", "BleGadgetWithFrc"]'

  PlatformIO-PackageAndPublish:
    name: PlatformIO - Package and Publish on Tag
    if: ${{ (github.ref_type == 'tag') || (github.ref_name == 'master') }}
    needs: PlatformIO-Build
    uses: sensirion/.github/.github/workflows/upt.platformio.publish.yml@main
    with:
      should-publish: ${{ github.ref_type == 'tag' }}
    secrets:
      pio-registry-token: ${{ secrets.PIO_MKTSW_TOKEN }}
